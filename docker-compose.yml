services:
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    container_name: demo-keycloak
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_HTTP_PORT: 8180
    command: start-dev --import-realm
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm.json:ro
    ports:
      - "8180:8180"
    networks:
      - demo-network
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8180"]
      interval: 5s
      timeout: 3s
      retries: 60
      start_period: 10s

  envoy:
    image: envoyproxy/envoy:v1.28-latest
    container_name: demo-envoy
    volumes:
      - ./envoy/envoy.yaml:/etc/envoy/envoy.yaml:ro
    ports:
      - "8080:8080"
      - "9901:9901"  # Admin interface for debugging
    networks:
      - demo-network
    depends_on:
      keycloak:
        condition: service_healthy
      public-app:
        condition: service_started
      alice-app:
        condition: service_started
      bob-app:
        condition: service_started
    command: ["-c", "/etc/envoy/envoy.yaml", "--log-level", "info"]

  public-app:
    build: ./public-app
    container_name: demo-public-app
    environment:
      - SERVICE_NAME=public-app
      - PORT=3000
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/health"]
      interval: 10s
      timeout: 3s
      retries: 3

  alice-app:
    build: ./alice-app
    container_name: demo-alice-app
    environment:
      - SERVICE_NAME=alice-app
      - PORT=3002
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3002/health"]
      interval: 10s
      timeout: 3s
      retries: 3

  bob-app:
    build: ./bob-app
    container_name: demo-bob-app
    environment:
      - SERVICE_NAME=bob-app
      - PORT=3001
    networks:
      - demo-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3001/health"]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  demo-network:
    driver: bridge
    name: demo-network
